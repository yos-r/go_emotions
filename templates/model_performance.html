{% extends "base.html" %}

{% block title %}Model Performance - GoEmotions{% endblock %}

{% block content %}
<div class="hero">
    <div class="container text-center">
        <h1 class="display-4">
            <i class="fas fa-chart-line"></i> Model Performance
        </h1>
        <p class="lead">
            Evaluate and compare performance metrics for all trained models
        </p>
    </div>
</div>

<div class="container">
    <!-- Model Selection -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h4 class="card-title">
                        <i class="fas fa-cog"></i> Select Model to Evaluate
                    </h4>

                    <div class="btn-group" role="group">
                        {% for model in models %}
                        <button
                            type="button"
                            class="btn btn-outline-primary evaluate-btn"
                            data-model="{{ model }}"
                        >
                            <i class="fas fa-robot"></i> {{ model|upper }}
                        </button>
                        {% endfor %}
                        <button type="button" class="btn btn-outline-success" id="evaluateAllBtn">
                            <i class="fas fa-layer-group"></i> Evaluate All Models
                        </button>
                    </div>

                    <div class="mt-3">
                        <p class="text-muted mb-0">
                            <i class="fas fa-info-circle"></i>
                            Click on a model to evaluate its performance on the test dataset.
                            This may take a few moments to compute.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading -->
    <div class="loading" id="loading" style="display: none;">
        <div class="spinner"></div>
        <p class="mt-3">Evaluating model... This may take a minute.</p>
    </div>

    <!-- Results Container -->
    <div id="resultsContainer"></div>

    <!-- Comparison Section -->
    <div id="comparisonSection" style="display: none;">
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title">
                            <i class="fas fa-balance-scale"></i> Model Comparison
                        </h4>
                        <div id="comparisonChart"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title">
                            <i class="fas fa-table"></i> Metrics Comparison Table
                        </h4>
                        <div class="table-responsive">
                            <table class="table table-striped" id="comparisonTable">
                                <thead>
                                    <tr>
                                        <th>Model</th>
                                        <th>Hamming Loss ↓</th>
                                        <th>AUC-ROC ↑</th>
                                        <th>F1-Micro ↑</th>
                                        <th>F1-Macro ↑</th>
                                        <th>Precision-Micro ↑</th>
                                        <th>Recall-Micro ↑</th>
                                    </tr>
                                </thead>
                                <tbody id="comparisonTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let allResults = {};

    // Evaluate single model
    $('.evaluate-btn').click(function() {
        const modelName = $(this).data('model');
        evaluateModel(modelName);
    });

    // Evaluate all models
    $('#evaluateAllBtn').click(function() {
        allResults = {};
        $('#loading').show();
        $('#resultsContainer').empty();
        $('#comparisonSection').hide();

        const models = {{ models|tojson }};
        let completed = 0;

        models.forEach(model => {
            $.ajax({
                url: `/api/evaluate-model/${model}`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({}),
                success: function(data) {
                    allResults[model] = data;
                    completed++;

                    if (completed === models.length) {
                        $('#loading').hide();
                        displayAllResults();
                        displayComparison();
                    }
                },
                error: function(xhr) {
                    alert(`Error evaluating ${model}: ${xhr.responseJSON?.error || 'Unknown error'}`);
                    $('#loading').hide();
                }
            });
        });
    });

    function evaluateModel(modelName) {
        $('#loading').show();
        $('#resultsContainer').empty();

        $.ajax({
            url: `/api/evaluate-model/${modelName}`,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({}),
            success: function(data) {
                allResults[modelName] = data;
                $('#loading').hide();
                displayModelResults(data);

                if (Object.keys(allResults).length > 1) {
                    displayComparison();
                }
            },
            error: function(xhr) {
                alert('Error: ' + (xhr.responseJSON?.error || 'Unknown error'));
                $('#loading').hide();
            }
        });
    }

    function displayModelResults(data) {
        const resultCard = $(`
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h4 class="card-title">
                                <i class="fas fa-robot"></i> ${data.model.toUpperCase()} Model Results
                            </h4>

                            <!-- Overall Metrics -->
                            <div class="row mt-4">
                                <div class="col-md-3">
                                    <div class="metric-card ${data.metrics.hamming_loss < 0.05 ? 'bg-success text-white' : ''}">
                                        <div class="metric-value">${data.metrics.hamming_loss.toFixed(4)}</div>
                                        <div class="metric-label">Hamming Loss</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="metric-card ${data.metrics.auc_roc_macro > 0.85 ? 'bg-success text-white' : ''}">
                                        <div class="metric-value">${data.metrics.auc_roc_macro.toFixed(4)}</div>
                                        <div class="metric-label">AUC-ROC (Macro)</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="metric-card">
                                        <div class="metric-value">${data.metrics.f1_micro.toFixed(4)}</div>
                                        <div class="metric-label">F1-Score (Micro)</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="metric-card">
                                        <div class="metric-value">${data.metrics.f1_macro.toFixed(4)}</div>
                                        <div class="metric-label">F1-Score (Macro)</div>
                                    </div>
                                </div>
                            </div>

                            <div class="row mt-3">
                                <div class="col-md-4">
                                    <div class="metric-card">
                                        <div class="metric-value">${data.metrics.precision_micro.toFixed(4)}</div>
                                        <div class="metric-label">Precision (Micro)</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="metric-card">
                                        <div class="metric-value">${data.metrics.precision_macro.toFixed(4)}</div>
                                        <div class="metric-label">Precision (Macro)</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="metric-card">
                                        <div class="metric-value">${data.metrics.threshold}</div>
                                        <div class="metric-label">Prediction Threshold</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Per-Emotion Metrics -->
                            <div class="mt-4">
                                <h5>Per-Emotion Performance</h5>
                                <div id="perEmotionChart-${data.model}"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `);

        $('#resultsContainer').append(resultCard);

        // Create per-emotion chart
        createPerEmotionChart(data);
    }

    function createPerEmotionChart(data) {
        const emotions = Object.keys(data.per_emotion);
        const f1Scores = emotions.map(e => data.per_emotion[e].f1);
        const precisions = emotions.map(e => data.per_emotion[e].precision);
        const recalls = emotions.map(e => data.per_emotion[e].recall);

        const trace1 = {
            x: emotions,
            y: f1Scores,
            name: 'F1-Score',
            type: 'bar'
        };

        const trace2 = {
            x: emotions,
            y: precisions,
            name: 'Precision',
            type: 'bar'
        };

        const trace3 = {
            x: emotions,
            y: recalls,
            name: 'Recall',
            type: 'bar'
        };

        const layout = {
            title: 'Per-Emotion Metrics',
            xaxis: { tickangle: -45 },
            yaxis: { title: 'Score', range: [0, 1] },
            barmode: 'group',
            height: 500
        };

        Plotly.newPlot(`perEmotionChart-${data.model}`, [trace1, trace2, trace3], layout);
    }

    function displayAllResults() {
        for (const [model, data] of Object.entries(allResults)) {
            displayModelResults(data);
        }
    }

    function displayComparison() {
        $('#comparisonSection').show();

        // Comparison chart
        const models = Object.keys(allResults);
        const metrics = ['hamming_loss', 'auc_roc_macro', 'f1_micro', 'f1_macro'];

        const traces = metrics.map(metric => ({
            x: models.map(m => m.toUpperCase()),
            y: models.map(m => allResults[m].metrics[metric]),
            name: metric.replace(/_/g, ' ').toUpperCase(),
            type: 'bar'
        }));

        const layout = {
            title: 'Model Metrics Comparison',
            xaxis: { title: 'Model' },
            yaxis: { title: 'Score' },
            barmode: 'group',
            height: 400
        };

        Plotly.newPlot('comparisonChart', traces, layout);

        // Comparison table
        const tbody = $('#comparisonTableBody');
        tbody.empty();

        for (const [model, data] of Object.entries(allResults)) {
            const row = $(`
                <tr>
                    <td><strong>${model.toUpperCase()}</strong></td>
                    <td>${data.metrics.hamming_loss.toFixed(4)}</td>
                    <td>${data.metrics.auc_roc_macro.toFixed(4)}</td>
                    <td>${data.metrics.f1_micro.toFixed(4)}</td>
                    <td>${data.metrics.f1_macro.toFixed(4)}</td>
                    <td>${data.metrics.precision_micro.toFixed(4)}</td>
                    <td>${data.metrics.recall_micro.toFixed(4)}</td>
                </tr>
            `);
            tbody.append(row);
        }
    }
</script>
{% endblock %}

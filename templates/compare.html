{% extends "base.html" %}

{% block title %}Compare Models - GoEmotions{% endblock %}

{% block content %}
<div class="hero">
    <div class="container text-center">
        <h1 class="display-4">
            <i class="fas fa-balance-scale"></i> Compare Models
        </h1>
        <p class="lead">
            Side-by-side comparison of all model architectures
        </p>
    </div>
</div>

<div class="container">
    <!-- Quick Comparison Button -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center">
                    <h4 class="card-title">
                        <i class="fas fa-rocket"></i> Quick Model Comparison
                    </h4>
                    <p class="text-muted">
                        Compare all models on a sample of 100 test examples
                    </p>
                    <button class="btn btn-primary btn-lg" id="compareBtn">
                        <i class="fas fa-play"></i> Run Comparison
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading -->
    <div class="loading" id="loading" style="display: none;">
        <div class="spinner"></div>
        <p class="mt-3">Running comparison... Please wait.</p>
    </div>

    <!-- Results -->
    <div id="results" style="display: none;">
        <!-- Metrics Comparison Chart -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title">
                            <i class="fas fa-chart-bar"></i> Performance Metrics Comparison
                        </h4>
                        <div id="metricsChart"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Comparison Table -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title">
                            <i class="fas fa-table"></i> Detailed Metrics
                        </h4>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="metricsTable">
                                <thead>
                                    <tr>
                                        <th>Model</th>
                                        <th>Hamming Loss <small>(lower is better)</small></th>
                                        <th>F1-Micro <small>(higher is better)</small></th>
                                        <th>F1-Macro <small>(higher is better)</small></th>
                                        <th>AUC-ROC <small>(higher is better)</small></th>
                                        <th>Ranking</th>
                                    </tr>
                                </thead>
                                <tbody id="metricsTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Model Architecture Comparison -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title">
                            <i class="fas fa-project-diagram"></i> Model Architecture Comparison
                        </h4>

                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>Model</th>
                                        <th>Architecture</th>
                                        <th>Key Features</th>
                                        <th>Threshold</th>
                                        <th>Complexity</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>LSTM</strong></td>
                                        <td>Embedding → LSTM(128) → Dense</td>
                                        <td>
                                            • Simple baseline<br>
                                            • Unidirectional<br>
                                            • No attention
                                        </td>
                                        <td>0.3</td>
                                        <td><span class="badge bg-success">Low</span></td>
                                    </tr>
                                    <tr>
                                        <td><strong>BiLSTM+Attention</strong></td>
                                        <td>Embedding → BiLSTM(128) → Attention → Dense</td>
                                        <td>
                                            • Bidirectional context<br>
                                            • Attention mechanism<br>
                                            • Weighted loss
                                        </td>
                                        <td>0.5</td>
                                        <td><span class="badge bg-warning">Medium</span></td>
                                    </tr>
                                    <tr>
                                        <td><strong>CNN-BiLSTM+Attention</strong></td>
                                        <td>Embedding → CNN → BiLSTM(64) → Attention → Dense</td>
                                        <td>
                                            • Hybrid architecture<br>
                                            • Multi-scale CNN features<br>
                                            • BiLSTM + Attention<br>
                                            • Weighted loss
                                        </td>
                                        <td>0.5</td>
                                        <td><span class="badge bg-danger">High</span></td>
                                    </tr>
                                    <tr>
                                        <td><strong>BERT</strong></td>
                                        <td>BERT-base (fine-tuned)</td>
                                        <td>
                                            • Transformer architecture<br>
                                            • Pre-trained on large corpus<br>
                                            • Transfer learning<br>
                                            • 110M parameters
                                        </td>
                                        <td>0.5</td>
                                        <td><span class="badge bg-danger">Very High</span></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Strengths and Weaknesses -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title">
                            <i class="fas fa-balance-scale-right"></i> Strengths & Weaknesses
                        </h4>

                        <div class="row">
                            <div class="col-md-6">
                                <h5 class="text-success">
                                    <i class="fas fa-plus-circle"></i> Strengths
                                </h5>
                                <ul>
                                    <li><strong>LSTM:</strong> Fast training, simple architecture, good baseline</li>
                                    <li><strong>BiLSTM+Attention:</strong> Better context understanding, attention weights for interpretability</li>
                                    <li><strong>CNN-BiLSTM:</strong> Multi-scale feature extraction, captures both local and sequential patterns</li>
                                    <li><strong>BERT:</strong> Pre-trained knowledge, state-of-the-art performance, transfer learning</li>
                                </ul>
                            </div>

                            <div class="col-md-6">
                                <h5 class="text-danger">
                                    <i class="fas fa-minus-circle"></i> Weaknesses
                                </h5>
                                <ul>
                                    <li><strong>LSTM:</strong> Unidirectional, no attention, struggles with long dependencies</li>
                                    <li><strong>BiLSTM+Attention:</strong> More complex, slower training than simple LSTM</li>
                                    <li><strong>CNN-BiLSTM:</strong> High complexity, requires more data, longer training time</li>
                                    <li><strong>BERT:</strong> Very high computational cost, requires GPU, large memory footprint</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recommendations -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card bg-light">
                    <div class="card-body">
                        <h4 class="card-title">
                            <i class="fas fa-lightbulb"></i> Recommendations
                        </h4>

                        <div class="alert alert-info">
                            <strong>For Production:</strong> Choose BiLSTM+Attention or CNN-BiLSTM+Attention for the best balance of performance and computational efficiency.
                        </div>

                        <div class="alert alert-success">
                            <strong>For Best Performance:</strong> Use BERT if computational resources are available and maximum accuracy is required.
                        </div>

                        <div class="alert alert-warning">
                            <strong>For Resource-Constrained Environments:</strong> Use simple LSTM with threshold tuning for acceptable performance with minimal resources.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $('#compareBtn').click(function() {
        $('#loading').show();
        $('#results').hide();

        $.ajax({
            url: '/api/compare-models',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({}),
            success: function(data) {
                displayComparison(data);
                $('#loading').hide();
                $('#results').show();
            },
            error: function(xhr) {
                alert('Error: ' + (xhr.responseJSON?.error || 'Unknown error'));
                $('#loading').hide();
            }
        });
    });

    function displayComparison(data) {
        // Create metrics chart
        const models = Object.keys(data);
        const metricNames = ['hamming_loss', 'f1_micro', 'f1_macro', 'auc_roc'];
        const metricLabels = {
            'hamming_loss': 'Hamming Loss (↓)',
            'f1_micro': 'F1-Micro (↑)',
            'f1_macro': 'F1-Macro (↑)',
            'auc_roc': 'AUC-ROC (↑)'
        };

        const traces = metricNames.map(metric => ({
            x: models.map(m => m.toUpperCase()),
            y: models.map(m => data[m][metric]),
            name: metricLabels[metric],
            type: 'bar'
        }));

        const layout = {
            title: 'Performance Metrics Comparison (Sample: 100 test examples)',
            xaxis: { title: 'Model' },
            yaxis: { title: 'Score' },
            barmode: 'group',
            height: 500
        };

        Plotly.newPlot('metricsChart', traces, layout);

        // Create metrics table with ranking
        const tbody = $('#metricsTableBody');
        tbody.empty();

        // Calculate ranking based on AUC-ROC
        const sortedModels = Object.entries(data).sort((a, b) => b[1].auc_roc - a[1].auc_roc);

        sortedModels.forEach(([model, metrics], index) => {
            const rankBadge = index === 0 ? 'bg-success' : index === 1 ? 'bg-info' : 'bg-secondary';
            const row = $(`
                <tr>
                    <td><strong>${model.toUpperCase()}</strong></td>
                    <td>${metrics.hamming_loss.toFixed(4)}</td>
                    <td>${metrics.f1_micro.toFixed(4)}</td>
                    <td>${metrics.f1_macro.toFixed(4)}</td>
                    <td>${metrics.auc_roc.toFixed(4)}</td>
                    <td><span class="badge ${rankBadge}">#${index + 1}</span></td>
                </tr>
            `);
            tbody.append(row);
        });

        // Highlight best values
        highlightBestValues(data);
    }

    function highlightBestValues(data) {
        // This function would add visual indicators for best performance
        // Already handled by the ranking column
    }
</script>
{% endblock %}
